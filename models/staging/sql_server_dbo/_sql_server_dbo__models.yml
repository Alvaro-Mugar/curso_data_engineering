version: 2

models:
  - name: stg_sql_server_dbo__promos
    description: >
      *Silver*-layer view that standardizes and enriches promotion data  
      from `source('sql_server_dbo', 'promos')`.  
      This model performs the following key transformations:
      1. Generates a deterministic identifier using `md5(promo_id)` (`promo_id`).
      2. Exposes the promotion name in `promotion_name`.
      3. Converts the discount value to an integer (`discount_dollars`).
      4. Normalizes the `status` field to lowercase.
      5. Converts the `_fivetran_synced` timestamp to UTC in `synced_utc`.
      6. Adds a synthetic "no promotion" record with default values  
         (`promo_id = md5('no_promo')`, `discount_dollars = 0`, `status = 'inactive'`).

    meta:
      owner: data-team
      layer: silver
      domain: sales
      contains_pii: false
      tags: ["silver", "promotions", "sql_server_dbo"]

    columns:
      - name: promo_id
        description: >
          Unique promotion identifier generated using `md5(promo_id)`.  
          Includes the synthetic record `md5('no_promo')` to represent  
          transactions without an associated promotion.
        tests:
          - not_null
          - unique

      - name: promotion_name
        description: >
          Name or key of the promotion, derived from the original `promo_id` field.  
          In the synthetic row, it takes the value `'no_promo'`.
        tests:
          - not_null

      - name: discount_dollars
        description: >
          Discount amount in U.S. dollars, converted to integer.  
          In the synthetic "no promotion" record, this value is set to 0.
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: promo_status
        description: >
          Promotion status converted to lowercase.  
          Examples include `'active'`, `'inactive'`, `'expired'`, `'scheduled'`.  
          In the synthetic row, it is set to `'inactive'`.
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['active','inactive']

      - name: synced_utc
        description: >
          Timestamp of the last synchronization, converted to UTC  
          and cast to `timestamp` type, derived from `_fivetran_synced`.
        tests:
          - not_null
          
  - name: stg_sql_server_dbo__products
    description: >
      **Silver-layer** model that transforms the `sql_server_dbo.products` source table.  
      It generates a surrogate key (`product_id`) by applying an MD5 hash  
      on the original UUID, standardizes data types, and normalizes the  
      `_fivetran_synced` field to UTC without time zone information.  
      
      This model is part of the **staging (silver)** layer and provides a  
      clean, consistent base for subsequent analytical models.

    meta:
      owner: data_team
      layer: silver
      domain: products
      contains_pii: false
      tags: ["silver", "products", "sql_server_dbo"]

    columns:
      - name: product_id
        description: >
          Surrogate key generated using the `md5(product_uuid)` function.  
          Serves as the internal product identifier within the *silver* layer.
        tests:
          - not_null
          - unique

      - name: product_uuid
        description: >
          Original product identifier (UUID) coming from the `sql_server_dbo` system.  
          Preserved for traceability and possible reconciliation with the source system.
        tests:
          - not_null

      - name: product_name
        description: >
          Product name as registered in the source system.
        tests:
          - not_null

      - name: product_price
        description: >
          Unit price of the product, cast to `FLOAT`.  
          All values are expected to be non-negative.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: inventory_units
        description: >
          Number of available inventory units, cast to `INTEGER`.  
          Negative values would indicate a load or synchronization error.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: synced_utc
        description: >
          Timestamp of the record’s last synchronization (`_fivetran_synced`),  
          converted to UTC (`TIMESTAMP_NTZ`) to ensure temporal consistency  
          across sources with different time zones.
        tests:
          - not_null

  - name: stg_sql_server_dbo__orders
    description: >
      **Silver** view that standardizes the `sql_server_dbo.orders` table.  
      Generates surrogate keys using MD5 hashes of business keys, normalizes numeric
      fields to FLOAT, and converts all timestamps to UTC with no time zone
      (`TIMESTAMP_NTZ`). Blank text fields are cleaned using `trim()` and converted
      to NULL via `nullif()` when applicable.
    meta:
      owner: data_team
      layer: silver
      domain: sales
      contains_pii: false
      tags: ["silver","orders","sql_server_dbo"]

    columns:
      - name: order_id
        description: >
          Surrogate key for the order (MD5 of `order_uuid`). Internal identifier
          within the silver layer.
        tests:
          - not_null
          - unique

      - name: order_uuid
        description: >
          Original order identifier from the source system. Preserved for traceability
          and reconciliation.
        tests:
          - not_null

      - name: shipping_service
        description: >
          Shipping service name. Blank strings are converted to NULL using
          `nullif(trim(shipping_service), '')`. May be NULL if not yet assigned or not applicable.
        tests: []

      - name: shipping_cost
        description: >
          Shipping cost as FLOAT (>= 0).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: address_id
        description: >
          Surrogate key for the address (MD5 of the original address identifier).
          Used as a technical FK towards the address dimension in later layers.
        tests:
          - not_null

      - name: created_at_utc
        description: >
          Order creation timestamp normalized to UTC and cast to `TIMESTAMP_NTZ`.
        tests:
          - not_null

      - name: promo_id
        description: >
          Promotion identifier for the order. Generated as MD5 of the source `promo_id`,
          applying a default synthetic record (`no_promo`) when missing.  
          Not unique since multiple orders can share the same promotion.
        tests: []

      - name: estimated_delivery_at_utc
        description: >
          Estimated delivery datetime normalized to UTC (`TIMESTAMP_NTZ`).  
          May be NULL for orders without an estimated delivery date.
        tests: []

      - name: order_cost
        description: >
          Order cost as FLOAT (>= 0).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: user_id
        description: >
          Surrogate key for the user (MD5 of the original user identifier).  
          Acts as a technical FK and is not unique within this model.
        tests:
          - not_null

  - name: stg_sql_server_dbo__order_items
    description: >
      Silver view for order line items from `sql_server_dbo.order_items`.
      Generates a line-level surrogate key (`order_item_id` = MD5(order_id|product_id)),
      exposes surrogate FKs to orders/products, preserves original business keys,
      enforces numeric typing, and normalizes sync timestamps to UTC (TIMESTAMP_NTZ).
    meta:
      owner: data_team
      layer: silver
      domain: sales
      contains_pii: false
      tags: ["silver","order_items","sql_server_dbo"]

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['order_uuid','product_uuid']

    columns:
      - name: order_item_id
        description: >
          Line-level surrogate key generated as MD5(order_id || '|' || product_id).
          Internal identifier for the order line in the silver layer.
        tests:
          - not_null
          - unique

      - name: order_id
        description: >
          Surrogate FK to orders (MD5 of original order_id). Matches `stg_sql_server_dbo__orders.order_id`.
        tests:
          - not_null
          - relationships:
              to: ref('stg_sql_server_dbo__orders')
              field: order_id

      - name: product_id
        description: >
          Surrogate FK to products (MD5 of original product_id). Matches `stg_sql_server_dbo__products.product_id`.
        tests:
          - not_null
          - relationships:
              to: ref('stg_sql_server_dbo__products')
              field: product_id

      - name: order_uuid
        description: Original order identifier from source (business key).
        tests:
          - not_null

      - name: product_uuid
        description: Original product identifier from source (business key).
        tests:
          - not_null

      - name: quantity
        description: Quantity of the product in the order line (NUMBER, >= 1).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1

      - name: synced_utc
        description: Source sync timestamp normalized to UTC (TIMESTAMP_NTZ).
        tests:
          - not_null

  - name: stg_sql_server_dbo__addresses
    description: >
      Silver view for addresses. Builds a surrogate key from `addresses_id`,
      trims textual fields, converts blanks to NULL where applicable, casts
      `zipcode` to text, and normalizes sync timestamps to UTC (TIMESTAMP_NTZ).
    meta:
      owner: data_team
      layer: silver
      domain: logistics
      contains_pii: false
      tags: ["silver","addresses","sql_server_dbo"]

    columns:
      - name: address_id
        description: Surrogate key (MD5 of `address_uuid`).
        tests: [not_null, unique]

      - name: address_uuid
        description: Original address identifier from source.
        tests: [not_null, unique]

      - name: country
        description: Country; trimmed.
        tests: [not_null]

      - name: address_line
        description: Street address; trimmed.
        tests: [not_null]

      - name: state
        description: State/region; trimmed.
        tests: []

      - name: zipcode
        description: ZIP/Postal code as text; blanks→NULL to preserve leading zeros.
        tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: '^\\d+$'

      - name: synced_utc
        description: Source sync timestamp normalized to UTC (TIMESTAMP_NTZ).
        tests: [not_null]

  - name: stg_sql_server_dbo__users
    description: >
      Silver view of users from `sql_server_dbo.users`. Generates surrogate keys (MD5)
      for both the user and address, preserves original business keys, normalizes all
      timestamps to UTC (`TIMESTAMP_NTZ`), and cleans text fields using `trim`.
    meta:
      owner: data_team
      layer: silver
      domain: customers
      contains_pii: false
      tags: ["silver","users","sql_server_dbo"]

    columns:
      - name: user_id
        description: Surrogate key for the user (MD5 of `user_uuid`). Technical PK in the silver layer.
        tests: [not_null, unique]

      - name: user_uuid
        description: Original user identifier from the source system (business key).
        tests: [not_null, unique]

      - name: updated_at_utc
        description: Last update timestamp normalized to UTC (`TIMESTAMP_NTZ`).

      - name: address_id
        description: Surrogate key for the address (MD5 of `address_uuid`). Technical FK to addresses.
        tests:
          - not_null
          - relationships:
              to: ref('stg_sql_server_dbo__addresses')
              field: address_id

      - name: address_uuid
        description: Original address identifier from the source system (business key).
        tests: [not_null]

      - name: user_last_name
        description: User’s last name (trimmed).
        tests: []

      - name: created_at_utc
        description: Account creation timestamp normalized to UTC (`TIMESTAMP_NTZ`).
        tests: [not_null]

      - name: user_phone_number
        description: Phone number trimmed. Expected US format `###-###-####`.
        tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: '^\d{3}-\d{3}-\d{4}$'
              row_condition: "phone_number is not null"

      - name: total_orders
        description: Total number of orders per user (`INTEGER`, >= 0).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: user_first_name
        description: User’s first name (trimmed).
        tests: []

      - name: user_email
        description: Lowercased and trimmed email address. Optional if not provided in the source.
        tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'
              row_condition: "user_email is not null"

      - name: synced_utc
        description: Ingestion sync timestamp normalized to UTC (`TIMESTAMP_NTZ`).
        tests: [not_null]
