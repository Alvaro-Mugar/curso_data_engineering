version: 2

models:
  - name: stg_google_sheets__budget
    description: >
      Staging view that standardizes the Google Sheets `budget` source to a
      canonical **monthly** grain per **product**. It normalizes the `month`
      field to the first day of the month, casts the quantity to an integer,
      builds a stable surrogate key, and converts the ingestion timestamp to UTC.
    meta:
      owner: data_team
      layer: silver
      domain: finance
      contains_pii: false
      tags: ["stg","google_sheets","budget","monthly","product"]

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ["product_id","month_start"]

    columns:
      - name: budget_id
        description: >
          Surrogate key for the monthly product budget (md5 of `product_id`
          and the normalized month). Guarantees stable uniqueness per product-month.
        tests:
          - not_null
          - unique

      - name: product_id
        description: >
          Product business key hashed to a stable identifier for joins downstream.
          Points to the product in the operational system.
        tests:
          - not_null
          - relationships:
              to: source('sql_server_dbo','products')
              field: product_id

      - name: month_start
        description: >
          Canonical month anchor as a DATE: the first day of the month derived
          from the raw `month` column (e.g., '2021-02-28' -> '2021-02-01').
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "extract(day from month_start) = 1"

      - name: quantity_budget
        description: >
          Planned quantity for the given product and month, cast to integer.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "quantity_budget >= 0"

      - name: synced_utc
        description: >
          Ingestion sync time converted to UTC (audit/control field).
        tests:
          - not_null